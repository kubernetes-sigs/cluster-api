
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Cluster Controller Â· The Cluster API Book</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="SIG Lifecycle Team">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-panel/icons.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-panel/panel.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-codegroup/code.group.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-theme-api/theme-api.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="machine_controller.html" />
    
    
    <link rel="prev" href="repository_layout.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Getting Started</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../getting_started/existing_providers.html">
            
                <a href="../getting_started/existing_providers.html">
            
                    
                    Existing Providers
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Common Code</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="architecture.html">
            
                <a href="architecture.html">
            
                    
                    Architecture
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="repository_layout.html">
            
                <a href="repository_layout.html">
            
                    
                    Repository Layout
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="3.3" data-path="cluster_controller.html">
            
                <a href="cluster_controller.html">
            
                    
                    Cluster Controller
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="machine_controller.html">
            
                <a href="machine_controller.html">
            
                    
                    Machine Controller
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="machineset_controller.html">
            
                <a href="machineset_controller.html">
            
                    
                    MachineSet Controller
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.6" data-path="machinedeployment_controller.html">
            
                <a href="machinedeployment_controller.html">
            
                    
                    MachineDeployment Controller
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Creating a New Provider</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../provider_implementations/overview.html">
            
                <a href="../provider_implementations/overview.html">
            
                    
                    Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../provider_implementations/naming.html">
            
                <a href="../provider_implementations/naming.html">
            
                    
                    Naming
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="../provider_implementations/generate_crds.html">
            
                <a href="../provider_implementations/generate_crds.html">
            
                    
                    Generate CRDs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="../provider_implementations/register_schemes.html">
            
                <a href="../provider_implementations/register_schemes.html">
            
                    
                    Register Schemes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="../provider_implementations/create_actuators.html">
            
                <a href="../provider_implementations/create_actuators.html">
            
                    
                    Create Actuators
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.6" data-path="../provider_implementations/register_controllers.html">
            
                <a href="../provider_implementations/register_controllers.html">
            
                    
                    Register Controllers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.7" data-path="../provider_implementations/building_running_and_testing.html">
            
                <a href="../provider_implementations/building_running_and_testing.html">
            
                    
                    Building, Running, and Testing
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Appendices</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../appendices/keps/0003-cluster-api.html">
            
                <a href="../appendices/keps/0003-cluster-api.html">
            
                    
                    Cluster API KEP
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Cluster Controller</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="cluster-resources">Cluster Resources</h1>
<p>A <code>Cluster</code> represents the global configuration of a Kubernetes cluster.</p>
<div class="api-method"><div class="api-method-definition"><h2 id="cluster">Cluster</h2>
<p>Cluster has 4 fields:</p>
<p><code>Spec</code> contains the desired cluster state specified by the object. While much
of the <code>Spec</code> is defined by users, unspecified parts may be filled in with
defaults or by Controllers such as autoscalers.</p>
<p><code>Status</code> contains only observed cluster state and is only written by
controllers. <code>Status</code> is not the source of truth for any information, but
instead aggregates and publishes observed state.</p>
<p><code>TypeMeta</code> contains metadata about the API itself - such as Group, Version, 
Kind.</p>
<p><code>ObjectMeta</code> contains metadata about the specific object instance, for example,
it&apos;s name, namespace, labels, and annotations, etc. <code>ObjectMeta</code> contains data 
common to most objects.</p>
</div><div class="api-method-code"><div class="api-method-sample" data-lang="go" data-name="Go"><pre><code class="lang-golang"><span class="hljs-comment">// Cluster is the Schema for the clusters API</span>
<span class="hljs-comment">// +k8s:openapi-gen=true</span>
<span class="hljs-comment">// +kubebuilder:subresource:status</span>
<span class="hljs-keyword">type</span> Cluster <span class="hljs-keyword">struct</span> {
    metav1.TypeMeta   <span class="hljs-string">`json:&quot;,inline&quot;`</span>
    metav1.ObjectMeta <span class="hljs-string">`json:&quot;metadata,omitempty&quot;`</span>

    Spec   ClusterSpec   <span class="hljs-string">`json:&quot;spec,omitempty&quot;`</span>
    Status ClusterStatus <span class="hljs-string">`json:&quot;status,omitempty&quot;`</span>
}
</code></pre>
</div></div></div>

<div class="api-method"><div class="api-method-definition"><h2 id="clusterspec">ClusterSpec</h2>
<p>The <code>ClusterNetwork</code> field includes the information necessary to configure
kubelet networking for <code>Pod</code>s and <code>Service</code>s.</p>
<p>The <code>ProviderSpec</code> is recommended to be a serialized API object in a format
owned by that provider. This will allow the configuration to be strongly typed,
versioned, and have as much nested depth as appropriate. These provider-specific
API definitions are meant to live outside of the Cluster API, which will allow
them to evolve independently of it.</p>
</div><div class="api-method-code"><div class="api-method-sample" data-lang="go" data-name="Go"><pre><code class="lang-golang"><span class="hljs-comment">// ClusterSpec defines the desired state of Cluster</span>
<span class="hljs-keyword">type</span> ClusterSpec <span class="hljs-keyword">struct</span> {
    <span class="hljs-comment">// Cluster network configuration</span>
    ClusterNetwork ClusterNetworkingConfig <span class="hljs-string">`json:&quot;clusterNetwork&quot;`</span>

    <span class="hljs-comment">// Provider-specific serialized configuration to use during</span>
    <span class="hljs-comment">// cluster creation. It is recommended that providers maintain</span>
    <span class="hljs-comment">// their own versioned API types that should be</span>
    <span class="hljs-comment">// serialized/deserialized from this field.</span>
    <span class="hljs-comment">// +optional</span>
    ProviderSpec ProviderSpec <span class="hljs-string">`json:&quot;providerSpec,omitempty&quot;`</span>
}
</code></pre>
</div></div></div>

<div class="api-method"><div class="api-method-definition"><h2 id="clusterstatus">ClusterStatus</h2>
<p>Like <code>ProviderSpec</code>, <code>ProviderStatus</code> is recommended to be a serialized API 
object in a format owned by that provider.</p>
<p>Some providers use the <code>APIEndpoint</code> field to determine when one or more
masters have been provisioned. This may be necessary before worker nodes
can be provisioned. For example, <code>cluster-api-provider-gcp</code> does <a href="https://github.com/kubernetes-sigs/cluster-api-provider-gcp/blob/f3145d8810a5c7fc434ddb5577699b4deb1b5fa6/pkg/cloud/google/metadata.go#L43" target="_blank">this</a>:</p>
<pre><code class="lang-go">    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(cluster.Status.APIEndpoints) == <span class="hljs-number">0</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;master endpoint not found in apiEndpoints for cluster %v&quot;</span>, cluster)
    }
</code></pre>
<p><strong>TODO</strong>: Provide examples of how <code>ErrorReason</code> and <code>ErrorMessage</code> are 
used in practice.</p>
</div><div class="api-method-code"><div class="api-method-sample" data-lang="go" data-name="Go"><pre><code class="lang-golang"><span class="hljs-comment">// ClusterStatus defines the observed state of Cluster</span>
<span class="hljs-keyword">type</span> ClusterStatus <span class="hljs-keyword">struct</span> {
    <span class="hljs-comment">// APIEndpoint represents the endpoint to communicate with the IP.</span>
    <span class="hljs-comment">// +optional</span>
    APIEndpoints []APIEndpoint <span class="hljs-string">`json:&quot;apiEndpoints,omitempty&quot;`</span>

    <span class="hljs-comment">// NB: Eventually we will redefine ErrorReason as ClusterStatusError once the</span>
    <span class="hljs-comment">// following issue is fixed.</span>
    <span class="hljs-comment">// https://github.com/kubernetes-incubator/apiserver-builder/issues/176</span>

    <span class="hljs-comment">// If set, indicates that there is a problem reconciling the</span>
    <span class="hljs-comment">// state, and will be set to a token value suitable for</span>
    <span class="hljs-comment">// programmatic interpretation.</span>
    <span class="hljs-comment">// +optional</span>
    ErrorReason common.ClusterStatusError <span class="hljs-string">`json:&quot;errorReason,omitempty&quot;`</span>

    <span class="hljs-comment">// If set, indicates that there is a problem reconciling the</span>
    <span class="hljs-comment">// state, and will be set to a descriptive error message.</span>
    <span class="hljs-comment">// +optional</span>
    ErrorMessage <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;errorMessage,omitempty&quot;`</span>

    <span class="hljs-comment">// Provider-specific status.</span>
    <span class="hljs-comment">// It is recommended that providers maintain their</span>
    <span class="hljs-comment">// own versioned API types that should be</span>
    <span class="hljs-comment">// serialized/deserialized from this field.</span>
    <span class="hljs-comment">// +optional</span>
    ProviderStatus *runtime.RawExtension <span class="hljs-string">`json:&quot;providerStatus,omitempty&quot;`</span>
}
</code></pre>
</div></div></div>

<div class="api-method"><div class="api-method-definition"><h2 id="cluster-actuator-interface">Cluster Actuator Interface</h2>
<p>All methods should be idempotent.</p>
<p><code>Reconcile()</code> will be called whenever there is a change to the <code>Cluster</code> 
<code>Spec</code>, or after every resync period.</p>
<p>If a <code>Cluster</code> resource is deleted, the controller will call the actuator&apos;s 
<code>Delete()</code> method until it succeeds, or the <a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/#finalizers" target="_blank">finalizer</a> is removed (see below).</p>
<p><strong>TODO</strong>: Determine what the current resync period is.</p>
</div><div class="api-method-code"><div class="api-method-sample" data-lang="go" data-name="Go"><pre><code class="lang-golang"><span class="hljs-comment">// Actuator controls clusters on a specific infrastructure. All</span>
<span class="hljs-comment">// methods should be idempotent unless otherwise specified.</span>
<span class="hljs-keyword">type</span> Actuator <span class="hljs-keyword">interface</span> {
    <span class="hljs-comment">// Reconcile creates or applies updates to the cluster.</span>
    Reconcile(*clusterv1.Cluster) error
    <span class="hljs-comment">// Delete the cluster.</span>
    Delete(*clusterv1.Cluster) error
}
</code></pre>
</div></div></div>

<h2 id="cluster-controller-semantics">Cluster Controller Semantics</h2>
<p><div class="panel panel-info"><div class="panel-heading"><div class="panel-icon"><i class="icon-info"></i></div><div class="panel-title">Logic sequence</div></div><div class="panel-content"><p>We need a diagram tracing the logic from resource creation through updates
and finally deletion. This was done using the sequences GitBook plugin.
Unfortunately there are (possibly personal) problems with phantomjs which
are making this difficult.</p>
</div></div></p>
<ol>
<li>If the <code>Cluster</code> hasn&apos;t been deleted and doesn&apos;t have a finalizer, add one.</li>
<li>If the <code>Cluster</code> is being deleted, and there is no finalizer, we&apos;re done.</li>
<li>Call the provider specific <code>Delete()</code> method.<ul>
<li>If the <code>Delete()</code> method returns true, remove the finalizer, we&apos;re done.</li>
</ul>
</li>
<li>If the <code>Cluster</code> has not been deleted, call the <code>Reconcile()</code> method.</li>
</ol>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            

        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Cluster Controller","level":"3.3","depth":1,"next":{"title":"Machine Controller","level":"3.4","depth":1,"path":"common_code/machine_controller.md","ref":"common_code/machine_controller.md","articles":[]},"previous":{"title":"Repository Layout","level":"3.2","depth":1,"path":"common_code/repository_layout.md","ref":"common_code/repository_layout.md","articles":[]},"dir":"ltr"},"config":{"plugins":["theme-api","panel","sequence-diagrams","ga","codegroup","mermaid","include-codeblock"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"panel":{},"search":{},"mermaid":{},"sequence-diagrams":{"theme":"simple"},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"codegroup":{"defaultTabName":"Code","rememberTabs":"false","tabNameSeperator":"::"},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"theme-api":{"languages":[],"split":true,"theme":"light"},"ga":{"configuration":"auto","token":"dew-create-me"},"include-codeblock":{"check":false,"edit":false,"fixlang":false,"lang":"","template":"default","theme":"chrome","unindent":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"SIG Lifecycle Team","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"The Cluster API Book","gitbook":">= 3.0.0"},"file":{"path":"common_code/cluster_controller.md","mtime":"2018-12-20T23:27:17.633Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-12-20T23:43:45.460Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-ga/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-codegroup/code.group.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-theme-api/theme-api.js"></script>
        
    

    </body>
</html>

