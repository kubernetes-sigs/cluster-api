name: PR verify

on:
  # pull_request_target:
  #   types: [opened, edited, synchronize, reopened]
  pull_request:

permissions:
  checks: write # Allow access to checks to write check runs.

jobs:
  verify-pr-type:
    runs-on: ubuntu-latest
    name: verify PR contents
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # tag=v4.1.7

      - name: Check if PR title has acceptable prefix
        run:  |
          targets=(":sparkles:" ":bug:" ":book:" ":seedling:" ":warning:" ":rocket:" ":running:" "✨" "🐛" "📚" "🌱" "⚠️" "🚀" "🏃")
          for target in "${targets[@]}"; do
            if echo '${{ github.event.pull_request.title }}' | grep -o ^$target; then
              exit 0
            fi
          done

      - name: Create a comment if PR title doesn't have acceptable prefix
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `I saw a title of ${{ github.event.pull_request.title }}, which doesn't seem to have any of the acceptable prefixes.

                You need to have one of these as the prefix of your PR title:
                
                - Breaking change: ⚠ ("warning")
                - Non-breaking feature: ✨ ("sparkles")
                - Patch fix: 🐛 ("bug")
                - Docs: 📖 ("book")
                - Release: 🚀 ("rocket")
                - Infra/Tests/Other: 🌱 ("seedling")
              `
            })

      - name: exit 1
        run: exit 1

  verify-pr-no-issue-number:
      - name: Check if there is no Issue or PR number
        run: |
          if echo '${{ github.event.pull_request.title }}' | grep -o -E -v '#[0-9]+'; then
            exit 0
          fi

      - name: Create a comment if PR title has issue or PR number
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `The title should just be descriptive.

                Issue numbers belong in the PR body as either "Fixes #XYZ" (if it closes the issue or PR), or something like "Related to #XYZ" (if it's just related).`,
              `
            })

      - name: exit 1
        run: exit 1

