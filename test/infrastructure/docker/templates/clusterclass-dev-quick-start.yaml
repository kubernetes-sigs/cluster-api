apiVersion: cluster.x-k8s.io/v1beta2
kind: ClusterClass
metadata:
  name: dev-quick-start
spec:
  controlPlane:
    templateRef:
      apiVersion: controlplane.cluster.x-k8s.io/v1beta2
      kind: KubeadmControlPlaneTemplate
      name: dev-quick-start-control-plane
    machineInfrastructure:
      templateRef:
        kind: DevMachineTemplate
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
        name: dev-quick-start-control-plane
    healthCheck:
      checks:
        unhealthyNodeConditions:
          - type: Ready
            status: Unknown
            timeoutSeconds: 300
          - type: Ready
            status: "False"
            timeoutSeconds: 300
        unhealthyMachineConditions:
          - type: "NodeReady"
            status: Unknown
            timeoutSeconds: 300
          - type: "NodeReady"
            status: "False"
            timeoutSeconds: 300
  infrastructure:
    templateRef:
      apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
      kind: DevClusterTemplate
      name: dev-quick-start-cluster
  workers:
    machinePools:
    - class: default-dev-worker
      bootstrap:
        templateRef:
          apiVersion: bootstrap.cluster.x-k8s.io/v1beta2
          kind: KubeadmConfigTemplate
          name: dev-quick-start-default-worker-bootstraptemplate
      infrastructure:
        templateRef:
          apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
          kind: DevMachinePoolTemplate
          name: dev-quick-start-default-dev-worker-machinepooltemplate
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: DevClusterTemplate
metadata:
  name: dev-quick-start-cluster
spec:
  template:
    spec:
      backend:
        docker:
          failureDomains:
            - name: fd1
              controlPlane: true
            - name: fd2
              controlPlane: true
            - name: fd3
              controlPlane: true
            - name: fd4
              controlPlane: true
            - name: fd5
              controlPlane: true
            - name: fd6
              controlPlane: false
            - name: fd7
              controlPlane: false
            - name: fd8
              controlPlane: false
---
kind: KubeadmControlPlaneTemplate
apiVersion: controlplane.cluster.x-k8s.io/v1beta2
metadata:
  name: dev-quick-start-control-plane
spec:
  template:
    spec:
      kubeadmConfigSpec:
        clusterConfiguration:
          apiServer:
            # host.docker.internal is required by kubetest when running on MacOS because of the way ports are proxied.
            certSANs: [localhost, 127.0.0.1, 0.0.0.0, host.docker.internal]
        initConfiguration:
          nodeRegistration: # node registration parameters are automatically injected by CAPD according to the kindest/node image in use.
            kubeletExtraArgs: # having a not empty kubeletExtraArgs is required for the externalCloudProvider patch to work
              - name: eviction-hard
                value: 'nodefs.available<0%,nodefs.inodesFree<0%,imagefs.available<0%'
        joinConfiguration:
          nodeRegistration: # node registration parameters are automatically injected by CAPD according to the kindest/node image in use.
            kubeletExtraArgs: # having a not empty kubeletExtraArgs is required for the externalCloudProvider patch to work
              - name: eviction-hard
                value: 'nodefs.available<0%,nodefs.inodesFree<0%,imagefs.available<0%'
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: DevMachineTemplate
metadata:
  name: dev-quick-start-control-plane
spec:
  template:
    spec:
      backend:
        docker:
          extraMounts:
          - containerPath: "/var/run/docker.sock"
            hostPath: "/var/run/docker.sock"
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: DockerMachineTemplate
metadata:
  name: dev-quick-start-default-worker-machinetemplate
spec:
  template:
    spec:
      extraMounts:
      - containerPath: "/var/run/docker.sock"
        hostPath: "/var/run/docker.sock"
---
apiVersion: bootstrap.cluster.x-k8s.io/v1beta2
kind: KubeadmConfigTemplate
metadata:
  name: dev-quick-start-default-worker-bootstraptemplate
spec:
  template:
    spec:
      joinConfiguration:
        nodeRegistration: # node registration parameters are automatically injected by CAPD according to the kindest/node image in use.
          kubeletExtraArgs: # having a not empty kubeletExtraArgs is required for the externalCloudProvider to work
            - name: eviction-hard
              value: 'nodefs.available<0%,nodefs.inodesFree<0%,imagefs.available<0%'
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: DevMachinePoolTemplate
metadata:
  name: dev-quick-start-default-dev-worker-machinepooltemplate
spec:
  template:
    spec:
      template: 
        docker: {}
